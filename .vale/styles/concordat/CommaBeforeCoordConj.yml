# Flag missing commas when FANBOYS join two explicit independent clauses.
# Lean on Vale's POS tagging to find an explicit subject + finite verb after
# the coordinator instead of guessing with token counts.
extends: sequence
level: warning
ignorecase: true
link: https://www.chicagomanualofstyle.org/qanda/data/faq/topics/Commas/faq0026.html
message: 'Add a comma before the coordinating conjunction; it joins two independent clauses.'

scope:
  - sentence
  - ~heading
  - ~list

tokens:
  # Left-hand clause already has a finite verb or modal.
  - tag: VBD|VBP|VBZ|MD
    skip: 80

  # FANBOYS anchor, but skip cases where punctuation already precedes the conjunction.
  - pattern: '(?<![,;:–—-]\s{0,5})(?<=\s)(?i:(?:for|and|nor|but|or|yet|so))(?!\s+that\b)'

  # Right-hand clause must start with an explicit subject token.
  - tag: PRP|PRP\$|EX|DT|NN|NNS|NNP|NNPS|CD
    skip: 6

  # Demand a finite verb or modal shortly after the subject.
  - tag: VBD|VBP|VBZ|MD
    skip: 6

action:
  name: edit
  params:
    - regex
    - '(?<![,;:–—-])\s+(?i:(for|and|nor|but|or|yet|so))\b'
    - ', $1'
